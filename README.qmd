---
# title: "corporations: pattern-based text extraction of corporation names in unstructured text and filtering of corporations"
format: gfm
editor-options: 
  chunk-output-type: console
execute:
  eval: true
  echo: true
---

<!--DO NOT EDIT .md file, only README.qmd--> 
# corporations

```{r}
#| include: false
devtools::load_all(".")
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  tidy = FALSE,
  fig.align = "center",
  comment = "#>",
  fig.path = "man/figures/README-",
  R.options = list(width = 120)
)
```

## Description 

The `corporations` `extract()` function is a regular-expression-based pattern match tool to match vector of text with a built-in extensive crosswalk table of corporations using the [regextable](https://github.com/judgelord/regextable) package as a dependency. The crosswalk table includes companies with a central index key (a unique 10-digit, permanent identification number assigned by the U.S. Securities and Exchange Commission), Compustat (database managed by the S&P Global Market Intelligence), and FDIC-insured companies. The `extract()` function requires one input

1. `input_data`: A vector of text to search (typically a data frame with a `text` column)

For each matching substring, `corprations::extract` returns 

- the row number of `data`  
- the `pattern` 
- the matched substring
- the `confidence_score` based on Jaro-Winkler fuzzy matching to validate extraction accuracy
- Optionally, other columns in `input_data` or the `corporations_data`

## Installation

```         
devtools::install_github("judgelord/corporations")
```

```{r, message=FALSE}
library(corporations)
```

## Data

The examples below use an subset of the corporations_data crosswalk table of members of corporations and a example text data from the listed contributors in Project 2025's "Mandate for Leadership: The Conservative Promise". 

```{r}
data("project_2025_coalition_and_contributors")
head(project_2025_coalition_and_contributors)

data("corporations_data_sample")
head(corporations_data_sample)
```

## Text cleaning

Before matching, by default, `clean_text()` from the [regextable](https://github.com/judgelord/regextable) is applied to standardize text for better matching in messy text. It converts text to lowercase, removes excess punctuation, replaces line breaks and dashes with spaces, and collapses multiple spaces into a single space. Text cleaning is applied only during matching and does not modify the original input data. Users can disable this behavior by setting `do_clean_text = FALSE`.

```{r}
text <- "  HELLO---WORLD  "
cleaned_text <- regextable::clean_text(text)
print(cleaned_text)
```

## Extract regex-based matches from text

### Description

`extract()` performs regex-based matching on a text column using the corporations lookup table. All patterns that match each row are returned, along with the corresponding pattern and optional metadata from the corporations table. If multiple patterns match the same text, multiple rows are returned, one per match.

### Required Parameters

-   **`data`**: A data frame or character vector containing the text to search.

### Optional Parameters

-   **`col_name`**: (default `"text"`) Column name in the data frame containing text to search through.
-   **`data_return_cols`**: (default `NULL`) Vector of additional columns from `data` to include in the output.
-   **`regex_return_cols`**: (default `NULL`) Vector of additional columns from `corporations_data` to include in the output (e.g., "FED_RSSD", "CIK").
-   **do_fuzzy_matching**: (default `TRUE`) If TRUE, applies fuzzy matching to the regular expression matches and includes another column of confidence scores for the matches.
-   **`remove_acronyms`**: (default `FALSE`) If `TRUE`, removes all-uppercase patterns from `regex_table`.
-   **`do_clean_text`**: (default `TRUE`) If `TRUE`, cleans text before matching.
-   **`verbose`**: (default `TRUE`) If `TRUE`, displays progress messages.
-   **`unique_match`** (default `FALSE`) If `TRUE`, stops searching after first match to find at most one match per row.
-   **`cl`**: (default `NULL`) A cluster object or integer specifying child processes for parallel evaluation (ignored on Windows).

### Returns

A data frame with one row per match, including:

- `row_id`: the internal row number of the text in the input data
- Optional columns from the input data (if data_return_cols specified)
- Optional columns from `corporations_data` (if regex_return_cols specified)
- `pattern`: the regex pattern matched
- `match`: the substring matched in the text
- `confidence_score`: the fuzzy matching score of the matched substring and the text from the input data

### Basic Usage

The simplest use of `extract()` with only the required arguments and returned columns specified. 
This finds all matches in the text column using the `corporations_data`.

```{r}
#Extract patterns using only required arguments
result <- extract(
  data = project_2025_coalition_and_contributors,
  col_name = "organization",
  data_return_cols = c("organization")
)

head(result)
```
